<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Space Invader Finder</title>
    <meta name="description" content="Space Invader Finder">
    <meta name="author" content="Laurie Copley">
    <style>
        .list-preview {
            list-style: none;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <h1>Space invader finder</h1>
        <p>Instructions Phasellus in tristique tellus. Nulla non ipsum ut augue scelerisque maximus. Nulla magna enim,
            tincidunt eu augue sit amet, tincidunt vulputate elit. Lorem ipsum dolor sit amet, consectetur adipiscing
            elit. In nulla ipsum, efficitur a facilisis lacinia, mollis auctor libero. Vivamus faucibus aliquam leo ut
            dapibus. Nullam scelerisque tempor mattis. Interdum et malesuada fames ac ante ipsum primis in faucibus.</p>

        <div><label for="shape">Shape:</label><input type="file" id="shape" name="shape" required accept=".txt" />
        </div>
        <div><label for="map">Map:</label><input type="file" id="map" name="map" required accept=".txt" /></div>
        <button onclick="return patternFinder.detectShapes()">Submit</button>

        <ul id="shapePreview" class="list-preview"></ul>
        <ul id="mapPreview" class="list-preview"></ul>
    </div>
    <script>
        if (window.File && window.FileReader) {
            var patternFinder = {
                $elements: {},
                shapeArray: [],
                mapArray: [],
                init: function () {
                    this.$elements.shapeInput = document.getElementById('shape');
                    this.$elements.mapInput = document.getElementById('map');
                    this.$elements.shapePreview = document.getElementById('shapePreview');
                    this.$elements.mapPreview = document.getElementById('mapPreview');

                    this.$elements.shapeInput.addEventListener('change', () => {
                        this.resolveInput(this.$elements.shapeInput).then(result => {
                            this.shapeArray =
                                result
                            return this.generatePreview(this.$elements.shapePreview, result);
                        })
                    });
                    this.$elements.mapInput.addEventListener('change', () => {
                        this.resolveInput(this.$elements.mapInput).then(result => {
                            this.mapArray =
                                result
                            return this.generatePreview(this.$elements.mapPreview, result)
                        })
                    });
                },
                resolveInput: ($element) => {
                    return new Promise((resolve, reject) => {
                        if ($element.files.length > 0 && $element.files[0]) {
                            const file = $element.files[0];
                            if (!file.type.match(/text.*/)) {
                                alert('Shape must be a .txt file');
                                resolve([]);
                            }
                            const fr = new FileReader();
                            fr.onload = () => {
                                resolve(fr.result.match(/[^\r?\n]+/g) || [])
                            }
                            fr.readAsText(file)
                        } else {
                            resolve([]);
                        }
                    })
                },
                generatePreview: ($element, lines) => {
                    while ($element.hasChildNodes()) {
                        $element.removeChild($element.firstChild);
                    }

                    lines.forEach(line => {
                        let li = document.createElement('li');
                        li.textContent = line;
                        $element.appendChild(li);
                    })
                },
                detectShapes: function () {
                    console.log('detecting shapes');
                    const heightSearchLimit = this.mapArray.length - this.shapeArray.length + 1;

                    for (let i = 0; i < heightSearchLimit; i++) {
                        let j = 0;
                        let regexp = new RegExp(this.shapeArray[j])
                        let match = this.mapArray[i + j].match(regexp);
                        const initialIndex = match ? match.index : undefined;


                        while (match && initialIndex === match.index) {
                            if (j + 1 === this.shapeArray.length) return {
                                line: i,
                                char: match.index
                            };
                            j++
                            regexp = new RegExp(this.shapeArray[j]);
                            match = this.mapArray[i + j].match(regexp);
                        }
                    }
                    return null;
                }
            }

            patternFinder.init();
        } else {
            console.log(window);
            //TODO: add fail case
        }
    </script>
</body>

</html>